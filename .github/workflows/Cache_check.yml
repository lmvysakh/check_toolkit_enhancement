name: Cache External Dependency Example (with sibling_repo)

on:
  # push:
  #   branches: [main]
  # pull_request:
  workflow_dispatch:

jobs:
  cache-external-dependency:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout your repo (lmvysakh/check_toolkit_enhancement)
      - name: Checkout main repo
        uses: actions/checkout@v4

      # Step 2: Checkout toolkit's PR branch with hashFiles enhancement
      - name: Checkout toolkit branch with hashFiles enhancement
        uses: actions/checkout@v4
        with:
          repository: mahabaleshwars/toolkit
          ref: enhancement/1035
          path: toolkit

      # Step 3: Install toolkit dependencies (if needed)
      - name: Install toolkit dependencies
        run: |
          cd toolkit
          npm install
          # npm run build    # Uncomment if build step is necessary

      # Step 4: Run hashFiles from toolkit for a file in sibling_repo/
      # Adjust the file name if you want to target something else!
      - name: Run hashFiles from toolkit
        id: hashfiles
        run: |
          HASH=$(node ./toolkit/scripts/hashFiles.js 'dependency.lock' 'sibling_repo')
          echo "hash=${HASH}" >> $GITHUB_OUTPUT

      # Step 5: Cache node_modules (or other cache path) using custom hash
      - name: Cache node_modules with custom external dependency hash
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ steps.hashfiles.outputs.hash }}

      # Step 6: Debug - print the sibling_repo/dependency.lock file hash using sha256sum
      - name: Show sibling_repo/dependency.lock hash (debug)
        run: |
          echo "Hash of sibling_repo/dependency.lock (using sha256sum):"
          sha256sum sibling_repo/dependency.lock || echo "File not found"
